name: Test

on:
  workflow_call:
    inputs:
      container:
        required: true
        type: string
      artifact:
        required: true
        type: string
      url:
        required: true
        type: string
      lhci_config:
        required: false
        type: string
        default: tests/lighthouserc.js
    secrets:
      LHCI_GITHUB_TOKEN:
        required: true
      NETLIFY_SITE_ID:
        required: true
      NETLIFY_AUTH_TOKEN:
        required: true

env:
  OUTPUT_DIR: public

jobs:
  local:
    name: Local tests
    runs-on: ubuntu-latest
    container: ${{ inputs.container }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.artifact }}
          path: ${{ env.OUTPUT_DIR }}
      - name: Install node dependencies
        run: npm ci
      - name: Run tests
        run: grunt test

  lighthouse:
    name: Lighthouse
    strategy:
      matrix:
        form: [desktop, mobile]
        url: ["/", "/research/"]
        include:
          - form: desktop
            preset: --collect.settings.preset=desktop
          - form: mobile
            preset:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: Install Lighthouse
        run: npm install && npm install -g @lhci/cli@0.9.x
      - name: Run Lighthouse
        run: lhci autorun ${{ inputs.lhci_args }} ${{ matrix.preset }} --collect.url="${{ inputs.url }}${{ matrix.url }}"
        env:
          LHCI_CONFIG: ${{ inputs.lhci_config }}
          LHCI_GITHUB_TOKEN: ${{ secrets.LHCI_GITHUB_TOKEN }}

  screenshot:
    uses: ./.github/workflows/screenshot.yml
    with:
      url: ${{ inputs.url }}
    secrets:
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
