---
import { type InferGetStaticPropsType, type GetStaticPaths } from "astro";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import Article from "@components/Article.astro";
import BaseLayout from "@layouts/BaseLayout.astro";
import Cover from "@components/Cover.astro";
import { type CoverData } from "@components/Cover.astro";

export const getStaticPaths = (async () => {
  const pages = await getCollection("pages");
  const posts = await getCollection("posts");
  return [...pages, ...posts].map((page) => ({
    params: { slug: page.slug },
    props: { page },
  }));
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

export async function getCover(
  page: CollectionEntry<"pages"> | CollectionEntry<"posts">,
): Promise<CoverData> {
  if (
    "collection" in page.data.cover &&
    page.data.cover.collection === "photos"
  ) {
    const entry = await getEntry(page.data.cover);
    if (entry == null) {
      throw new Error(`Photo cover not found: ${page.data.cover.id}`);
    }
    return entry;
  }
  if ("data" in page.data.cover) {
    return {
      id: undefined,
      data: page.data.cover.data,
    };
  }
  throw new Error(`Invalid page: ${page.id}`);
}

const { page } = Astro.props;
const posts = (
  await getCollection("posts", ({ data }) => {
    return !data.draft;
  })
).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const index = posts.findIndex((other) => other.id === page.id);
const { Content, remarkPluginFrontmatter } = await page.render();
const cover = await getCover(page);
---

<BaseLayout
  tab={page.data.tab ?? "blog"}
  title={page.data.title}
  description={remarkPluginFrontmatter.description}
>
  <div class="flex flex-col items-center gap-4 sm:gap-12 lg:gap-24">
    <Cover
      image={cover}
      previous={index > 0 ? `./${posts[index - 1].slug}` : undefined}
      next={index >= 0 && index < posts.length - 1
        ? `./${posts[index + 1].slug}`
        : undefined}
      actionHref={cover.id !== undefined
        ? `/photography/${cover.id}`
        : undefined}
      actionIcon="/icons/link-image.svg"
      actionAlt="Image details"
    />
    <Article title={page.data.title} date={page.data.date}>
      <Content />
    </Article>
  </div>
</BaseLayout>
